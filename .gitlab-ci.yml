image: registry.gitlab.com/bluestarsports/devops/docker-base-images/bss-php71-kubectl-envsubst:latest
stages:
  - setup
  - test
  - build
  - build_workers
  - deploy

setup:
  type: setup
  script:
    - composer install --quiet --no-interaction
    - cp .env.testing .env
  cache:
    key: ${CI_BUILD_REF_NAME}
    paths:
      - vendor/
  artifacts:
    expire_in: 1 week
    paths:
      - vendor/

test:
  services:
    - postgres:9.6-alpine
  variables:
    POSTGRES_USER: root
    POSTGRES_PASSWORD: root
    POSTGRES_DB: npdb-usafb
  type: test
  script:
    - cp .env.testing .env
    - php artisan migrate:refresh --seed
    - composer test

lint:
  type: test
  script:
    - composer lint

automation:
  services:
    - postgres:9.6-alpine
  variables:
    POSTGRES_USER: root
    POSTGRES_PASSWORD: root
    POSTGRES_DB: npdb-usafb
  type: test
  script:
    - cp .env.testing .env
    - composer env:prereq
    - php artisan migrate:refresh --seed
    - php -S localhost:8000 -t public 1>/dev/null &
    - composer --global config process-timeout 20000
    - composer test:reg
    - cp .env.testing .env
    - killall php


build:
  image: docker:latest
  variables:
    DOCKER_DRIVER: overlay
    DOCKER_HOST: tcp://localhost:2375
  services:
    - docker:dind
  before_script:
    - docker info
  stage: build
  only:
    - develop
    - master
    - CD-fixes
  allow_failure: false
  script:
    - docker login registry.gitlab.com -u npdbtest -p $gitlab_personal_token
    - docker build -t registry.gitlab.com/bluestarsports/npdb-usafb-api --build-arg GIT_DEPLOYED_SHA="$CI_COMMIT_SHA" .
    - docker push registry.gitlab.com/bluestarsports/npdb-usafb-api

build_nginx_static:
  stage: build_workers
  image: docker:latest
  variables:
    DOCKER_DRIVER: overlay
    DOCKER_HOST: tcp://localhost:2375
  services:
    - docker:dind
  before_script:
    - docker info
  only:
    - develop
    - master
    - CDs-fixes
  script:
    - docker login registry.gitlab.com -u npdbtest -p $gitlab_personal_token
    - docker build -t registry.gitlab.com/bluestarsports/npdb-usafb-api/npdb-usafb-api-nginx -f Dockerfile.nginx .
    - docker push registry.gitlab.com/bluestarsports/npdb-usafb-api/npdb-usafb-api-nginx


deploy:
  stage: deploy
  only:
    - develop
    - master
    - CD-fixes
  allow_failure: false
  environment:
    name: staging
  before_script:
    - . deploy/scripts/setup_kube_config.sh
  script:
    - kubectl cluster-info
    - . deploy/scripts/deploy_app.sh
